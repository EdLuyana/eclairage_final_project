{% extends 'base.html.twig' %}

{% block title %}{{ page_title ?? 'Vente' }}{% endblock %}

{% block body %}
<div class="container py-4">

    {# Header : titre + magasin + retour dashboard #}
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="h3 mb-1">{{ page_title }}</h1>
            {% if current_location is defined and current_location %}
                <p class="text-muted mb-1 small">
                    Magasin actuel :
                    <strong>{{ current_location.name }}</strong>
                    <span class="text-muted">({{ current_location.code }})</span>
                </p>
            {% endif %}
            <a href="{{ path('user_select_location') }}" class="btn btn-link p-0 small">
                Changer de magasin
            </a>
        </div>

        <div class="d-flex flex-column align-items-end gap-2">
            <a href="{{ path('user_dashboard') }}" class="btn btn-outline-secondary btn-sm">
                ← Retour au dashboard
            </a>
        </div>
    </div>

    {# Flashes #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
            </div>
        {% endfor %}
    {% endfor %}

    <div class="row g-4">

        {# ============================ #
           |   COLONNE GAUCHE : VENTE   |
           # ============================ #}
        <div class="col-12 col-lg-5">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h2 class="h5 mb-3">Ajouter un article au panier</h2>

                    <p class="text-muted small">
                        Scannez <code>RÉFÉRENCE-TAILLE</code> ou saisissez la référence.
                        Sélectionnez ensuite la taille et la quantité.
                    </p>

                    <form id="sell_add_line_form" method="post" action="{{ path('user_sell_add_line') }}">

                        {# --- Référence --- #}
                        <div class="mb-3">
                            <label for="sell_reference" class="form-label">Référence produit</label>
                            <input
                                type="text"
                                id="sell_reference"
                                name="reference"
                                class="form-control form-control-lg"
                                autocomplete="off"
                                placeholder="Scannez ou tapez la référence"
                                required
                                data-autocomplete="product-reference"
                                list="product_reference_autocomplete"
                            >
                            <div class="form-text">
                                Scannez <code>REFERENCE-TAILLE</code> ou saisissez la référence.
                            </div>
                        </div>

                        {# --- Tailles (injection JS) --- #}
                        <div class="mb-3">
                            <label class="form-label d-block">Taille</label>
                            <div id="sell_sizes_buttons" class="d-flex flex-wrap gap-2"></div>

                            <input type="hidden" id="sell_size_id" name="size_id">

                            <div class="form-text">
                                Sélectionnez une taille disponible dans ce magasin.
                            </div>
                        </div>

                        {# --- Quantité --- #}
                        <div class="mb-3">
                            <label for="sell_quantity" class="form-label">Quantité</label>
                            <input
                                type="number"
                                id="sell_quantity"
                                name="quantity"
                                class="form-control"
                                min="1"
                                value="1"
                                required
                            >
                        </div>

                        {# --- Boutons --- #}
                        <div class="d-flex justify-content-between align-items-center">
                            <button
                                type="submit"
                                class="btn btn-primary btn-lg"
                                id="sell_add_to_cart_btn"
                            >
                                Ajouter au panier
                            </button>

                            <button type="reset" class="btn btn-outline-secondary btn-sm">
                                Réinitialiser
                            </button>
                        </div>

                    </form>

                </div>
            </div>
        </div>


        {# ================================================= #
           |        COLONNE DROITE : PANIER + PAIEMENT       |
           # ================================================= #}
        <div class="col-12 col-lg-7 d-flex flex-column gap-4">

            {# --- Panier --- #}
            <div class="card border-0 shadow-sm flex-grow-1">
                <div class="card-body">
                    <h2 class="h5 mb-3">Panier</h2>

                    {% if cart is empty %}
                        <p class="text-muted">Aucun article dans le panier.</p>

                    {% else %}
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th>Référence</th>
                                        <th>Produit</th>
                                        <th class="text-center">Taille</th>
                                        <th class="text-center">Qté</th>
                                        <th class="text-end">PU</th>
                                        <th class="text-center">Remise article</th>
                                        <th class="text-end">Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lineKey, line in cart %}
                                        {% set unit = line.unit_price %}
                                        {% set qty = line.quantity %}
                                        {% set line_discount = line.discount_percent|default(0) %}
                                        {% set original_total = unit * qty %}
                                        {% set final_total = (line_discount > 0)
                                            ? original_total * (1 - (line_discount / 100))
                                            : original_total
                                        %}

                                        <tr>
                                            <td><code>{{ line.reference }}</code></td>
                                            <td>{{ line.name }}</td>
                                            <td class="text-center">{{ line.size_name }}</td>
                                            <td class="text-center">{{ qty }}</td>
                                            <td class="text-end">{{ unit|number_format(2, ',', ' ') }} €</td>

                                            {# --- Remises par article --- #}
                                            <td class="text-center">
                                                <form
    method="post"
    action="{{ path('user_sell_set_line_discount', { lineKey: lineKey }) }}"
    class="d-grid gap-1"
    style="grid-template-columns: repeat(3, 1fr); max-width: 260px; margin: 0 auto;"
>
    {% set line_current = line.discount_percent|default(0) %}

    {# Ligne 1 : 0%, -10%, -20% #}
    <button
        type="submit"
        name="discount_percent"
        value="0"
        class="btn btn-sm {% if line_current == 0 %}btn-outline-secondary active{% else %}btn-outline-secondary{% endif %}"
        {% if not sale_mode_enabled %}disabled{% endif %}
    >0%</button>

    <button
        type="submit"
        name="discount_percent"
        value="10"
        class="btn btn-sm {% if line_current == 10 %}btn-success{% else %}btn-outline-success{% endif %}"
        {% if not sale_mode_enabled %}disabled{% endif %}
    >-10%</button>

    <button
        type="submit"
        name="discount_percent"
        value="20"
        class="btn btn-sm {% if line_current == 20 %}btn-success{% else %}btn-outline-success{% endif %}"
        {% if not sale_mode_enabled %}disabled{% endif %}
    >-20%</button>

    {# Ligne 2 : -30%, -40%, -50% #}
    <button
        type="submit"
        name="discount_percent"
        value="30"
        class="btn btn-sm {% if line_current == 30 %}btn-success{% else %}btn-outline-success{% endif %}"
        {% if not sale_mode_enabled %}disabled{% endif %}
    >-30%</button>

    <button
        type="submit"
        name="discount_percent"
        value="40"
        class="btn btn-sm {% if line_current == 40 %}btn-success{% else %}btn-outline-success{% endif %}"
        {% if not sale_mode_enabled %}disabled{% endif %}
    >-40%</button>

    <button
        type="submit"
        name="discount_percent"
        value="50"
        class="btn btn-sm {% if line_current == 50 %}btn-success{% else %}btn-outline-success{% endif %}"
        {% if not sale_mode_enabled %}disabled{% endif %}
    >-50%</button>

</form>

{% if not sale_mode_enabled %}
    <div class="text-muted small mt-1 text-center">
        Mode soldes désactivé
    </div>
{% endif %}


                                                {% if not sale_mode_enabled %}
                                                    <div class="text-muted small mt-1">
                                                        Mode promotions désactivé
                                                    </div>
                                                {% endif %}
                                            </td>

                                            {# Total #}
                                            <td class="text-end">
                                                {% if line_discount > 0 %}
                                                    <div class="small text-muted text-decoration-line-through">
                                                        {{ original_total|number_format(2, ',', ' ') }} €
                                                    </div>
                                                    <strong>{{ final_total|number_format(2, ',', ' ') }} €</strong>
                                                {% else %}
                                                    <strong>{{ original_total|number_format(2, ',', ' ') }} €</strong>
                                                {% endif %}
                                            </td>

                                            <td class="text-end">
                                                <form method="post"
                                                      action="{{ path('user_sell_remove_line', { lineKey }) }}">
                                                    <button class="btn btn-sm btn-outline-danger">✕</button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <form method="post" action="{{ path('user_sell_clear_cart') }}" class="mt-2">
                            <button class="btn btn-outline-secondary btn-sm">Vider le panier</button>
                        </form>
                    {% endif %}
                </div>
            </div>

            {# --- Paiement --- #}
            <div class="card border-0 shadow-sm">
                <div class="card-body">

                    <h2 class="h5 mb-3">Récapitulatif & paiement</h2>

                    {% if cart is empty %}
                        <p class="text-muted">Ajoutez un article pour voir le récapitulatif.</p>

                    {% else %}
                        {% set total_brut = totals.total %}
                        {% set total_after = totals.total_after_discount %}
                        {% set discount_detail = totals.discount_detail %}
                        {% set basket_discount_percent = basket_discount_percent %}

                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Total brut</span>
                                <strong>{{ total_brut|number_format(2, ',', ' ') }} €</strong>
                            </div>

                            <div class="d-flex justify-content-between">
                                <span>Remises articles</span>
                                {% if discount_detail.line_rate_sum > 0 %}
                                    <span class="text-success">-
                                        {{ discount_detail.line_rate_sum|number_format(2, ',', ' ') }} €
                                    </span>
                                {% else %}
                                    <span class="text-muted">Aucune</span>
                                {% endif %}
                            </div>

                            <div class="d-flex justify-content-between">
                                <span>Remise panier</span>
                                {% if basket_discount_percent == 10 %}
                                    <span>-10%</span>
                                {% else %}
                                    <span class="text-muted">Aucune</span>
                                {% endif %}
                            </div>

                            <div class="d-flex justify-content-between">
                                <span>Total après remises</span>
                                <strong>{{ total_after|number_format(2, ',', ' ') }} €</strong>
                            </div>
                        </div>

                        {# Remise panier toujours dispo #}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold">Remise panier (-10 %)</span>
                                <span class="badge bg-info text-dark">Toujours disponible</span>
                            </div>

                            <form method="post" action="{{ path('user_sell_toggle_discount') }}" class="d-flex gap-2">
                                <button
                                    type="submit"
                                    name="discount_percent"
                                    value="0"
                                    class="btn btn-sm
                                        {% if basket_discount_percent == 0 %}btn-outline-secondary active
                                        {% else %}btn-outline-secondary{% endif %}"
                                >
                                    Aucune
                                </button>

                                <button
                                    type="submit"
                                    name="discount_percent"
                                    value="10"
                                    class="btn btn-sm
                                        {% if basket_discount_percent == 10 %}btn-success
                                        {% else %}btn-outline-success{% endif %}"
                                >
                                    -10%
                                </button>
                            </form>

                            <p class="text-muted small mt-1">
                                Cette remise s'applique sur le total après remises articles.
                            </p>
                        </div>

                        {# Bon d'achat #}
                        <div class="mb-3">
                            <form method="post" action="{{ path('user_sell_set_voucher') }}"
                                  class="row gy-2 gx-2 align-items-end">
                                <div class="col-7 col-md-5">
                                    <label for="voucher_amount" class="form-label mb-1">Bon d'achat (€)</label>
                                    <input
                                        type="number"
                                        id="voucher_amount"
                                        name="voucher_amount"
                                        class="form-control"
                                        min="0"
                                        step="1"
                                        value="{{ voucher_amount }}"
                                    >
                                </div>
                                <div class="col-5 col-md-auto">
                                    <button type="submit" class="btn btn-outline-primary w-100">
                                        Appliquer
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Bon d'achat utilisé</span>
                                <strong>{{ voucher_amount }} €</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="fw-semibold">Montant à payer</span>
                                <span class="fw-bold fs-5">
                                    {{ cash_amount|number_format(2, ',', ' ') }} €
                                </span>
                            </div>
                        </div>

                        <form method="post" action="{{ path('user_sell_validate') }}">
                            <button type="submit" class="btn btn-success btn-lg w-100">
                                Valider la vente
                            </button>
                        </form>

                    {% endif %}
                </div>
            </div>

        </div>

    </div>
</div>
{% endblock %}
